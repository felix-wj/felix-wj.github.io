(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{559:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"问题描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[s._v("#")]),s._v(" 问题描述")]),s._v(" "),t("p",[s._v("之前在搭建"),t("code",[s._v("ELK")]),s._v("日志收集系统时，使用"),t("code",[s._v("Kinaba")]),s._v("做了异常日志统计的看板。但是今天发现有些异常日志可以被搜索，但是在统计看板中没有统计到。")]),s._v(" "),t("p",[s._v("通过对比可被统计和不可被统计的日志字段，发现不可被统计的日志是因为没有创建"),t("code",[s._v("keyword")]),s._v("字段，通过检查索映射发现这个字段配置如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"content"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"fields"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"keyword"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyword"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ignore_above"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("可知是异常日志超长，导致"),t("code",[s._v("keyword")]),s._v("字段无法创建。")]),s._v(" "),t("h2",{attrs:{id:"解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),t("p",[s._v("异常日志因为打印堆栈信息，通常会很长。如果只是简单的修改"),t("code",[s._v("ignore_above")]),s._v("的值，则需要调为很大的值，在做聚合统计时肯定会影响性能。")]),s._v(" "),t("p",[s._v("所以一开始想试试在"),t("code",[s._v("ElasticSearch")]),s._v("中能否将"),t("code",[s._v("content.keyword")]),s._v("截取，但是查询后发现"),t("code",[s._v("ElasticSearch")]),s._v("不支持对"),t("code",[s._v("keyword")]),s._v("字段进行截取。")]),s._v(" "),t("p",[s._v("然后转而试试能否在"),t("code",[s._v("Logstash")]),s._v("处理日志时进行截取。")]),s._v(" "),t("p",[s._v("最终查到通过"),t("code",[s._v("logstash")]),s._v("的"),t("code",[s._v("mutate")]),s._v("插件的"),t("code",[s._v("gsub")]),s._v("功能截取日志。为了不丢失原始日志，可以将截取后的日志存入一个新的字段，如"),t("code",[s._v("content_short")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('filter {\n    grok {\n        match => { "message" => "%{DATA:timestamp} %{LOGLEVEL:loglevel} %{DATA:logger} %{DATA:class} \\[%{DATA:traceId}\\] \\[%{DATA:biz}\\] \\[%{DATA:logFollower}\\] %{GREEDYDATA:content}" }\n    }\n    mutate {\n        add_field => { "content_short" => "%{content}" }\n        gsub => [\n            "content_short", "(.{255}).*", "\\1"\n        ]\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("这段配置的含义如下：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("mutate")]),s._v("：这是 "),t("code",[s._v("Logstash")]),s._v(" 的一个插件，用于对事件数据进行各种转换操作。")]),s._v(" "),t("li",[t("code",[s._v("gsub")]),s._v("：这是 "),t("code",[s._v("mutate")]),s._v(" 插件的一个功能，用于对字段值进行正则表达式替换。")]),s._v(" "),t("li",[t("code",[s._v('"(?m)(.{256}).*"')]),s._v("："),t("code",[s._v("(?m)")]),s._v(" 是一个模式修饰符，使 "),t("code",[s._v(".")]),s._v(" 匹配任何字符，包括换行符。"),t("code",[s._v("(.{256}).*")]),s._v(" 匹配前 256 个字符和之后的所有字符。")]),s._v(" "),t("li",[t("code",[s._v('"\\1"')]),s._v("：这是替换字符串。"),t("code",[s._v("\\1")]),s._v(" 表示正则表达式中的第一个捕获组，即前 256 个字符。")])]),s._v(" "),t("p",[s._v("这样就可以在"),t("code",[s._v("Kibana")]),s._v("中使用"),t("code",[s._v("content_short")]),s._v("字段进行聚合统计了。")])])}),[],!1,null,null,null);t.default=n.exports}}]);